
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Study of Rapach and Zhou's 2012 paper uing updated data</title><meta name="generator" content="MATLAB 8.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-02-02"><meta name="DC.source" content="UpdatedRapachZhou.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Study of Rapach and Zhou's 2012 paper uing updated data</h1><!--introduction--><p>Author: Peiliang Guo Runs 14 regressors including market info and macro factors on equity premium Predicts out of sample market returns and compare with historical average benchmark prediction. Includes predictions using Kitchen-sink and POOL-avg prediction</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">helper functions</a></li><li><a href="#2">data processing</a></li><li><a href="#3">Making predictions using predictors, and plotting</a></li><li><a href="#4">Performance of predictions of individual predictors</a></li><li><a href="#5">Plot of Actual predictions from individual predictors</a></li><li><a href="#6">Performance of Kitchen sink and POOL-AVG predictions</a></li><li><a href="#7">Actual predictions of Kitchen sink and POOL-AVG</a></li></ul></div><h2>helper functions<a name="1"></a></h2><pre class="codeinput">warning(<span class="string">'off'</span>,<span class="string">'all'</span>)
dbtype <span class="string">predict_r.m</span>
dbtype <span class="string">plot_pred.m</span>
dbtype <span class="string">plot_pred_perf.m</span>
</pre><pre class="codeoutput">
1     function pred = predict_r(X,y,test_idx)
2         l = length(X);
3         const_ones = ones(l,1);
4         pred = zeros(l-test_idx+1,1);
5         for i = 1: l-test_idx+1
6             hist_l = test_idx-2+i;
7             beta = regress(y(2:hist_l),[const_ones(1:hist_l-1) X(1:hist_l-1,:)]);
8             pred(i) = [1 X(hist_l,:)]*beta;
9         end
10    
11    end

1     function plot_pred(pred, r_avg, test_year,custom_ylim,label)
2         l = length(pred(:,1));
3         x_year = test_year:1/12:(test_year+l/12);
4         plot(x_year,zeros(length(x_year),1),'color',[0 0 0]+0.5)
5         
6         plot(x_year,[0; pred],'color',[0 0 0])
7         plot(x_year,[0; r_avg],'color',[0 0 0]+0.7)
8         xlim([test_year test_year+l/12]+1/12)
9         ylim(custom_ylim)
10        title(label)
11        set(gca, 'XTick', 1965:10:2015)
12    end

1     function plot_pred_perf(pred,r_avg,r_test,test_year,custom_ylim,label)
2         l = length(pred(:,1));
3         cdsfe = zeros(l,2);
4         prev = [0 0];
5         for i = 1:l
6             avg_err2 = (r_test(i)-r_avg(i))^2;
7             cdsfe(i,1) = prev(1) + avg_err2 - (r_test(i) - pred(i))^2;
8             cdsfe(i,2) = prev(2) + avg_err2 - (r_test(i) - max(0,pred(i)))^2;
9             prev(1) = cdsfe(i,1);
10            prev(2) = cdsfe(i,2);
11        end
12        x_year = test_year:1/12:(test_year+l/12);
13        plot(x_year,zeros(length(x_year),1),'color',[0 0 0])
14        plot(x_year,[0; cdsfe(:,2)],'color',[0 0 0]+0.4)
15        plot(x_year,[0; cdsfe(:,1)],'color',[0 0 0])
16        xlim([test_year test_year+l/12]+1/12)
17        ylim(custom_ylim)
18        title(label)
19        set(gca, 'XTick', 1965:10:2015)
20    end
21        
</pre><h2>data processing<a name="2"></a></h2><pre class="codeinput">raw_data = xlsread(<span class="string">'PredictorData2015.xlsx'</span>,<span class="string">'Monthly'</span>);
label = {<span class="string">'A. log(DP)'</span>, <span class="string">'B. log(DY)'</span>, <span class="string">'C. log(EP)'</span>, <span class="string">'D. log(DE)'</span>,<span class="keyword">...</span>
    <span class="string">'E. SVAR'</span>, <span class="string">'F. BM'</span>, <span class="string">'G. NTIS'</span>, <span class="string">'H. TBL'</span>,<span class="keyword">...</span>
    <span class="string">'I. LTY'</span>, <span class="string">'J. LTR'</span>, <span class="string">'K.TMS'</span>, <span class="string">'L. DFY'</span>,<span class="keyword">...</span>
    <span class="string">'M. DFR'</span>, <span class="string">'N. INFL'</span>};
<span class="comment">% starting date of monthly data Dec 1926</span>
begin_date = 192612;
begin_idx = find(raw_data(:,1)== begin_date);
lagged_data = raw_data(begin_idx-1,:); <span class="comment">%data at one lag</span>
raw_data = raw_data(begin_idx:end,:);

<span class="comment">%out of sample testing begins from Jan 1957</span>
test_date = 195701;
test_idx = find(raw_data(:,1)==test_date);
test_year = round(test_date/100);

<span class="comment">%NBER data indicating troughs of business cycles (after 1957)</span>
troughs = [195708 195808; 196004 196102; 196912 197011;
    197311 197503; 198001 198007; 198107 198211; 199007 199103;
    200103 200111; 200712 200906];

<span class="comment">%realized equity premium (excess return)</span>
r = log(1+raw_data(:,17))-raw_data(:,11);

<span class="comment">%predictors</span>
log_price = log(raw_data(:,2));
log_div = log(raw_data(:,3));
log_earning = log(raw_data(:,4));
log_dp = log_div - log_price;
log_dy = log_div - [log(lagged_data(1,2)); log_price(1:end-1)];
log_ep = log_earning - log_price;
log_de = log_div - log_earning;
svar = raw_data(:,15);
bm = raw_data(:,5);
ntis = raw_data(:,10);
tbl = raw_data(:,6);
lty = raw_data(:,9);
ltr = raw_data(:,13);
tms = lty - tbl;
dfy = raw_data(:,8) - raw_data(:,7);
dfr = raw_data(:,14) - ltr;
infl = raw_data(:,12);

pred_data = zeros(length(raw_data),14);
pred_data(:,1) = log_dp;
pred_data(:,2) = log_dy;
pred_data(:,3) = log_ep;
pred_data(:,4) = log_de;
pred_data(:,5) = svar;
pred_data(:,6) = bm;
pred_data(:,7) = ntis;
pred_data(:,8) = tbl;
pred_data(:,9) = lty;
pred_data(:,10) = ltr;
pred_data(:,11) = tms;
pred_data(:,12) = dfy;
pred_data(:,13) = dfr;
pred_data(:,14) = infl;

<span class="comment">%benchmark historical avg mkt</span>
test_len = length(raw_data) - test_idx + 1;
r_avg = zeros(test_len,1);
prev_r_avg = mean(r(1:test_idx-1));
<span class="keyword">for</span> i = 1:test_len
    r_avg(i) = prev_r_avg;
    prev_r_avg = (prev_r_avg*(test_idx-2+i)+<span class="keyword">...</span>
        r(test_idx-1+i))/(test_idx-1+i);
<span class="keyword">end</span>
</pre><h2>Making predictions using predictors, and plotting<a name="3"></a></h2><p>prediction performance measured by sum of squared error of ep_avg benchmark minus sse of prediction</p><pre class="codeinput"><span class="comment">% actual historical equity premium</span>
r_test = r(test_idx:end);

<span class="comment">%initializing prediction matrix</span>
r_pred = zeros(length(raw_data)-test_idx+1,16);

<span class="comment">%prediction</span>
<span class="keyword">for</span> i = 1:14
    r_pred(:,i) = predict_r(pred_data(:,i),r,test_idx);
<span class="keyword">end</span>
<span class="comment">%kitchen sink pred</span>
r_pred(:,15) = predict_r(pred_data,r,test_idx);
<span class="comment">%pool-avg pred</span>
r_pred(:,16) = mean(r_pred(:,1:14),2);
</pre><h2>Performance of predictions of individual predictors<a name="4"></a></h2><p>Measured by cumulative error relative to historical average prediction</p><pre class="codeinput">figure(1)
set(gcf,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[0 0 30 30])
<span class="keyword">for</span> i = 1:14
    subplot(4,4,i)
    hold <span class="string">on</span>
    plot_troughs(troughs)
    plot_pred_perf(r_pred(:,i), r_avg, r_test,test_year,[-0.029 0.02],label(i))
    hold <span class="string">off</span>
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="UpdatedRapachZhou_01.png" alt=""> <h2>Plot of Actual predictions from individual predictors<a name="5"></a></h2><pre class="codeinput">figure(2)
set(gcf,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[0 0 30 30])
<span class="keyword">for</span> i = 1:14
    subplot(4,4,i)
    hold <span class="string">on</span>
    plot_troughs(troughs)
    plot_pred(r_pred(:,i), r_avg, test_year,[-0.025,0.025],label(i))
    hold <span class="string">off</span>
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="UpdatedRapachZhou_02.png" alt=""> <h2>Performance of Kitchen sink and POOL-AVG predictions<a name="6"></a></h2><pre class="codeinput">figure(3)
subplot(2,1,1)
hold <span class="string">on</span>
plot_troughs(troughs)
plot_pred_perf(r_pred(:,15), r_avg, r_test,test_year,[-0.102 0.002],<span class="string">'A. Kitchen sink'</span>)
hold <span class="string">off</span>
subplot(2,1,2)
hold <span class="string">on</span>
plot_troughs(troughs)
plot_pred_perf(r_pred(:,16), r_avg, r_test,test_year,[-0.005 0.02],<span class="string">'C. POOL-AVG'</span>)
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="UpdatedRapachZhou_03.png" alt=""> <h2>Actual predictions of Kitchen sink and POOL-AVG<a name="7"></a></h2><pre class="codeinput">figure(4)
subplot(2,1,1)
hold <span class="string">on</span>
plot_troughs(troughs)
plot_pred(r_pred(:,15),r_avg,test_year,[-0.07,0.04],<span class="string">'A. Kitchen sink'</span>)
hold <span class="string">off</span>
subplot(2,1,2)
hold <span class="string">on</span>
plot_troughs(troughs)
plot_pred(r_pred(:,16),r_avg,test_year,[-0.003,0.01],<span class="string">'C. POOL-AVG'</span>)
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="UpdatedRapachZhou_04.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Study of Rapach and Zhou's 2012 paper uing updated data
% Author: Peiliang Guo
% Runs 14 regressors including market info and macro factors on equity premium
% Predicts out of sample market returns and compare with historical average
% benchmark prediction. 
% Includes predictions using Kitchen-sink and POOL-avg prediction
%% helper functions
warning('off','all')
dbtype predict_r.m
dbtype plot_pred.m
dbtype plot_pred_perf.m
%% data processing
raw_data = xlsread('PredictorData2015.xlsx','Monthly');
label = {'A. log(DP)', 'B. log(DY)', 'C. log(EP)', 'D. log(DE)',...
    'E. SVAR', 'F. BM', 'G. NTIS', 'H. TBL',...
    'I. LTY', 'J. LTR', 'K.TMS', 'L. DFY',...
    'M. DFR', 'N. INFL'};
% starting date of monthly data Dec 1926
begin_date = 192612;
begin_idx = find(raw_data(:,1)== begin_date); 
lagged_data = raw_data(begin_idx-1,:); %data at one lag
raw_data = raw_data(begin_idx:end,:);

%out of sample testing begins from Jan 1957
test_date = 195701;
test_idx = find(raw_data(:,1)==test_date);
test_year = round(test_date/100);

%NBER data indicating troughs of business cycles (after 1957)
troughs = [195708 195808; 196004 196102; 196912 197011;
    197311 197503; 198001 198007; 198107 198211; 199007 199103;
    200103 200111; 200712 200906];

%realized equity premium (excess return)
r = log(1+raw_data(:,17))-raw_data(:,11);

%predictors
log_price = log(raw_data(:,2));
log_div = log(raw_data(:,3));
log_earning = log(raw_data(:,4));
log_dp = log_div - log_price;
log_dy = log_div - [log(lagged_data(1,2)); log_price(1:end-1)];
log_ep = log_earning - log_price;
log_de = log_div - log_earning;
svar = raw_data(:,15);
bm = raw_data(:,5);
ntis = raw_data(:,10);
tbl = raw_data(:,6);
lty = raw_data(:,9);
ltr = raw_data(:,13);
tms = lty - tbl;
dfy = raw_data(:,8) - raw_data(:,7);
dfr = raw_data(:,14) - ltr;
infl = raw_data(:,12);

pred_data = zeros(length(raw_data),14);
pred_data(:,1) = log_dp;
pred_data(:,2) = log_dy;
pred_data(:,3) = log_ep;
pred_data(:,4) = log_de;
pred_data(:,5) = svar;
pred_data(:,6) = bm;
pred_data(:,7) = ntis;
pred_data(:,8) = tbl;
pred_data(:,9) = lty;
pred_data(:,10) = ltr;
pred_data(:,11) = tms;
pred_data(:,12) = dfy;
pred_data(:,13) = dfr;
pred_data(:,14) = infl;

%benchmark historical avg mkt
test_len = length(raw_data) - test_idx + 1;
r_avg = zeros(test_len,1);
prev_r_avg = mean(r(1:test_idx-1));
for i = 1:test_len
    r_avg(i) = prev_r_avg;
    prev_r_avg = (prev_r_avg*(test_idx-2+i)+...
        r(test_idx-1+i))/(test_idx-1+i);
end


%% Making predictions using predictors, and plotting 
% prediction performance measured by sum of squared error 
% of ep_avg benchmark minus sse of prediction

% actual historical equity premium
r_test = r(test_idx:end);

%initializing prediction matrix
r_pred = zeros(length(raw_data)-test_idx+1,16);

%prediction
for i = 1:14
    r_pred(:,i) = predict_r(pred_data(:,i),r,test_idx);
end
%kitchen sink pred
r_pred(:,15) = predict_r(pred_data,r,test_idx);
%pool-avg pred
r_pred(:,16) = mean(r_pred(:,1:14),2);

%% Performance of predictions of individual predictors
% Measured by cumulative error relative to historical average prediction
figure(1)
set(gcf,'units','centimeters','position',[0 0 30 30])
for i = 1:14
    subplot(4,4,i)
    hold on
    plot_troughs(troughs)
    plot_pred_perf(r_pred(:,i), r_avg, r_test,test_year,[-0.029 0.02],label(i))
    hold off
end

%% Plot of Actual predictions from individual predictors
figure(2)
set(gcf,'units','centimeters','position',[0 0 30 30])
for i = 1:14
    subplot(4,4,i)
    hold on
    plot_troughs(troughs)
    plot_pred(r_pred(:,i), r_avg, test_year,[-0.025,0.025],label(i))
    hold off
end

%% Performance of Kitchen sink and POOL-AVG predictions
figure(3)
subplot(2,1,1)
hold on
plot_troughs(troughs)
plot_pred_perf(r_pred(:,15), r_avg, r_test,test_year,[-0.102 0.002],'A. Kitchen sink')
hold off
subplot(2,1,2)
hold on
plot_troughs(troughs)
plot_pred_perf(r_pred(:,16), r_avg, r_test,test_year,[-0.005 0.02],'C. POOL-AVG')
hold off

%% Actual predictions of Kitchen sink and POOL-AVG
figure(4)
subplot(2,1,1)
hold on
plot_troughs(troughs)
plot_pred(r_pred(:,15),r_avg,test_year,[-0.07,0.04],'A. Kitchen sink')
hold off
subplot(2,1,2)
hold on
plot_troughs(troughs)
plot_pred(r_pred(:,16),r_avg,test_year,[-0.003,0.01],'C. POOL-AVG')
hold off

##### SOURCE END #####
--></body></html>